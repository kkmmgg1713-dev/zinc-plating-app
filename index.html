<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- OCR Library -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <title>ÏïÑÏó∞ÎèÑÍ∏àÎëêÍªò Ï∏°Ï†ï</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        header h1 {
            font-size: 1.3rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .material-section {
            margin-bottom: 10px;
        }

        .material-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .material-header-title {
            font-size: 0.9rem;
            color: #aaa;
        }

        .material-selector {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 10px 5px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .material-btn-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }

        .material-btn {
            flex-shrink: 0;
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .material-btn:hover {
            background: rgba(233, 30, 99, 0.3);
        }

        .material-btn.active {
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            border-color: #fff;
        }

        .edit-icon {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-icon:hover {
            background: rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        .add-material-btn {
            flex-shrink: 0;
            padding: 10px 15px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: transparent;
            color: #aaa;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-material-btn:hover {
            border-color: #e91e63;
            color: #e91e63;
        }

        .sample-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding: 10px 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .sample-btn {
            flex-shrink: 0;
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .sample-btn:hover {
            background: rgba(0, 212, 255, 0.3);
        }

        .sample-btn.active {
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            border-color: #fff;
            transform: scale(1.05);
        }

        .sample-btn.completed {
            background: linear-gradient(135deg, #00c853, #00e676);
        }

        .measurement-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 15px;
        }

        .current-sample-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .current-sample-header h2 {
            font-size: 1.2rem;
            color: #00d4ff;
        }

        .progress-indicator {
            font-size: 0.85rem;
            color: #aaa;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .data-input-wrapper {
            position: relative;
        }

        .data-input-wrapper label {
            position: absolute;
            top: 2px;
            left: 8px;
            font-size: 0.65rem;
            color: #888;
        }

        .data-input {
            width: 100%;
            height: 55px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
            text-align: center;
            padding-top: 12px;
            transition: all 0.3s ease;
        }

        .data-input:focus {
            outline: none;
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .data-input.filled {
            border-color: #00c853;
            background: rgba(0, 200, 83, 0.1);
        }

        .data-input.current {
            border-color: #ff9800;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(255, 152, 0, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(255, 152, 0, 0.8);
            }
        }

        .results-section {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(123, 44, 191, 0.2));
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .results-title {
            text-align: center;
            font-size: 1rem;
            margin-bottom: 12px;
            color: #00d4ff;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .result-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .result-box.min {
            border-left: 4px solid #ff5722;
        }

        .result-box.avg {
            border-left: 4px solid #4caf50;
        }

        .result-label {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .result-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .result-box.min .result-value {
            color: #ff5722;
        }

        .result-box.avg .result-value {
            color: #4caf50;
        }

        .result-unit {
            font-size: 0.75rem;
            color: #888;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn.clear {
            background: linear-gradient(135deg, #ff5722, #ff9800);
            color: #fff;
        }

        .action-btn.next {
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            color: #fff;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .summary-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 15px;
        }

        .summary-title {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #00d4ff;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .summary-table th,
        .summary-table td {
            padding: 10px 5px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-table th {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }

        .summary-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .export-btn {
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #9c27b0, #e91e63);
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-btn:active {
            transform: scale(0.98);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 255, 0.5);
            border-radius: 3px;
        }

        /* Camera Modal Styles */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1000;
            flex-direction: column;
        }

        .camera-view {
            flex: 1;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 100px;
            border: 2px solid rgba(0, 212, 255, 0.8);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }
        
        .camera-guide-text {
            position: absolute;
            top: -30px;
            left: 0;
            width: 100%;
            text-align: center;
            color: #00d4ff;
            font-weight: bold;
            font-size: 0.9rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .camera-controls {
            height: 140px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding-bottom: 20px;
        }

        .shutter-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #fff;
            border: 5px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .shutter-btn:active {
            transform: scale(0.9);
            background: #ddd;
        }

        .close-camera-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1001;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1002;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
        
        .camera-btn {
            background: linear-gradient(135deg, #673ab7, #3f51b5);
            color: #fff;
            width: 100%;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üî¨ ÏïÑÏó∞ÎèÑÍ∏àÎëêÍªò Ï∏°Ï†ï ÌîÑÎ°úÍ∑∏Îû®</h1>
        </header>

        <div class="material-section">
            <div class="material-header">
                <span class="material-header-title">üì¶ ÏûêÏû¨ ÏÑ†ÌÉù</span>
            </div>
            <div class="material-selector" id="materialSelector">
                <!-- Material buttons will be generated here -->
            </div>
        </div>

        <div class="sample-selector" id="sampleSelector">
            <!-- Sample buttons will be generated here -->
        </div>

        <div class="measurement-card">
            <div class="current-sample-header">
                <h2 id="currentSampleTitle">ÏûêÏû¨ 1 - ÏãúÎ£å #1</h2>
                <span class="progress-indicator" id="progressIndicator">0 / 20</span>
            </div>

            <div class="data-grid" id="dataGrid">
                <!-- Data inputs will be generated here -->
            </div>

            <div class="results-section">
                <h3 class="results-title">üìä Ï∏°Ï†ï Í≤∞Í≥º</h3>
                <div class="results-grid">
                    <div class="result-box min">
                        <div class="result-label">ÏµúÏÜüÍ∞í</div>
                        <div class="result-value" id="minValue">-</div>
                        <div class="result-unit">Œºm</div>
                    </div>
                    <div class="result-box avg">
                        <div class="result-label">ÌèâÍ∑†Í∞í</div>
                        <div class="result-value" id="avgValue">-</div>
                        <div class="result-unit">Œºm</div>
                    </div>
                </div>
            </div>

            <div class="action-buttons" style="flex-direction: column;">
                <button class="action-btn camera-btn" onclick="startCamera()">üì∑ Ïπ¥Î©îÎùºÎ°ú Ïà´Ïûê ÏûÖÎ†•</button>
                <div style="display: flex; gap: 10px; width: 100%;">
                    <button class="action-btn clear" onclick="clearCurrentSample()">Ï¥àÍ∏∞Ìôî</button>
                    <button class="action-btn next" onclick="goToNextSample()">Îã§Ïùå ÏãúÎ£å ‚Üí</button>
                </div>
            </div>
        </div>

        <div class="summary-section">
            <h3 class="summary-title">üìã Ï†ÑÏ≤¥ ÏãúÎ£å ÏöîÏïΩ</h3>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>ÏãúÎ£å</th>
                        <th>ÏµúÏÜüÍ∞í (Œºm)</th>
                        <th>ÌèâÍ∑†Í∞í (Œºm)</th>
                    </tr>
                </thead>
                <tbody id="summaryTableBody">
                    <!-- Summary rows will be generated here -->
                </tbody>
            </table>
            <button class="export-btn" onclick="exportData()">üì§ Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
        </div>
    </div>

    <script>
        const TOTAL_SAMPLES = 13;
        const MEASUREMENTS_PER_SAMPLE = 20;

        // Data storage - now supports multiple materials
        let materials = []; // Array of material objects, each containing allData
        let currentMaterial = 0;
        let currentSample = 0;

        // Get current material's data
        function getAllData() {
            return materials[currentMaterial].samples;
        }

        // Initialize data structure for a single material
        function createMaterialData(materialNumber) {
            const samples = [];
            for (let i = 0; i < TOTAL_SAMPLES; i++) {
                samples.push({
                    sampleNumber: i + 1,
                    measurements: new Array(MEASUREMENTS_PER_SAMPLE).fill(null),
                    min: null,
                    avg: null
                });
            }
            return {
                materialNumber: materialNumber,
                name: `ÏûêÏû¨ ${materialNumber}`,
                samples: samples
            };
        }

        // Initialize with one material
        function initializeData() {
            materials = [createMaterialData(1)];
            currentMaterial = 0;
            currentSample = 0;
        }

        // Add a new material
        function addMaterial() {
            const newMaterialNum = materials.length + 1;
            materials.push(createMaterialData(newMaterialNum));
            generateMaterialSelector();
            selectMaterial(materials.length - 1); // Switch to new material
        }

        // Select a material
        function selectMaterial(index) {
            currentMaterial = index;
            currentSample = 0;
            generateMaterialSelector();
            generateSampleSelector();
            generateDataGrid();
            updateResults();
            updateProgress();
            updateSummaryTable();
            updateCurrentTitle();
        }

        // Generate material selector buttons
        function generateMaterialSelector() {
            const selector = document.getElementById('materialSelector');
            selector.innerHTML = '';

            for (let i = 0; i < materials.length; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'material-btn-wrapper';

                const btn = document.createElement('button');
                btn.className = 'material-btn' + (i === currentMaterial ? ' active' : '');
                btn.textContent = materials[i].name;
                btn.onclick = () => selectMaterial(i);

                const editBtn = document.createElement('button');
                editBtn.className = 'edit-icon';
                editBtn.innerHTML = '‚úèÔ∏è';
                editBtn.title = 'Ïù¥Î¶Ñ Î≥ÄÍ≤Ω';
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    renameMaterial(i);
                };

                wrapper.appendChild(btn);
                wrapper.appendChild(editBtn);
                selector.appendChild(wrapper);
            }

            // Add "ÏûêÏû¨ Ï∂îÍ∞Ä" button
            const addBtn = document.createElement('button');
            addBtn.className = 'add-material-btn';
            addBtn.textContent = '+ ÏûêÏû¨ Ï∂îÍ∞Ä';
            addBtn.onclick = addMaterial;
            selector.appendChild(addBtn);
        }

        // Rename material
        function renameMaterial(index) {
            const currentName = materials[index].name;
            const newName = prompt('ÏûêÏû¨ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', currentName);

            if (newName && newName.trim() !== '') {
                materials[index].name = newName.trim();
                generateMaterialSelector();
                updateCurrentTitle();
            }
        }

        // Update current sample title
        function updateCurrentTitle() {
            document.getElementById('currentSampleTitle').textContent =
                `${materials[currentMaterial].name} - ÏãúÎ£å #${currentSample + 1}`;
        }

        // Generate sample selector buttons
        function generateSampleSelector() {
            const selector = document.getElementById('sampleSelector');
            selector.innerHTML = '';
            const allData = getAllData();

            for (let i = 0; i < TOTAL_SAMPLES; i++) {
                const btn = document.createElement('button');
                btn.className = 'sample-btn' + (i === currentSample ? ' active' : '');
                btn.textContent = i + 1;
                btn.onclick = () => selectSample(i);

                // Check if sample is completed
                if (allData[i] && allData[i].measurements.every(m => m !== null)) {
                    btn.classList.add('completed');
                }

                selector.appendChild(btn);
            }
        }

        // Generate data input grid
        function generateDataGrid() {
            const grid = document.getElementById('dataGrid');
            grid.innerHTML = '';
            const allData = getAllData();

            for (let i = 0; i < MEASUREMENTS_PER_SAMPLE; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'data-input-wrapper';

                const label = document.createElement('label');
                label.textContent = `#${i + 1}`;

                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'data-input';
                input.id = `input-${i}`;
                input.inputMode = 'decimal';
                input.step = '0.1';
                input.placeholder = '';

                // Set value if exists
                if (allData[currentSample] && allData[currentSample].measurements[i] !== null) {
                    input.value = allData[currentSample].measurements[i];
                    input.classList.add('filled');
                }

                // Event listeners
                input.addEventListener('input', (e) => handleInput(i, e.target.value));
                input.addEventListener('keydown', (e) => handleKeydown(i, e));
                input.addEventListener('focus', () => highlightCurrentInput(i));

                wrapper.appendChild(label);
                wrapper.appendChild(input);
                grid.appendChild(wrapper);
            }

            // Highlight first empty input
            highlightNextEmpty();
        }

        // Handle input change
        function handleInput(index, value) {
            const numValue = value === '' ? null : parseFloat(value);
            const allData = getAllData();
            allData[currentSample].measurements[index] = numValue;

            const input = document.getElementById(`input-${index}`);
            if (numValue !== null) {
                input.classList.add('filled');
            } else {
                input.classList.remove('filled');
            }

            updateResults();
            updateProgress();
            generateSampleSelector();
        }

        // Handle keydown events
        function handleKeydown(index, e) {
            if (e.key === 'Enter') {
                e.preventDefault();

                // Move to next input
                const nextIndex = index + 1;
                if (nextIndex < MEASUREMENTS_PER_SAMPLE) {
                    const nextInput = document.getElementById(`input-${nextIndex}`);
                    nextInput.focus();
                } else {
                    // All inputs filled, show completion
                    document.activeElement.blur();
                }
            }
        }

        // Highlight current input
        function highlightCurrentInput(index) {
            // Remove current class from all
            document.querySelectorAll('.data-input').forEach(input => {
                input.classList.remove('current');
            });

            // Add current class to focused input
            const input = document.getElementById(`input-${index}`);
            if (input) {
                input.classList.add('current');
            }
        }

        // Find and highlight next empty input
        function highlightNextEmpty() {
            const allData = getAllData();
            for (let i = 0; i < MEASUREMENTS_PER_SAMPLE; i++) {
                if (allData[currentSample].measurements[i] === null) {
                    const input = document.getElementById(`input-${i}`);
                    if (input) {
                        input.classList.add('current');
                        input.focus();
                    }
                    break;
                }
            }
        }

        // Update results display
        function updateResults() {
            const allData = getAllData();
            const measurements = allData[currentSample].measurements.filter(m => m !== null);

            if (measurements.length > 0) {
                const min = Math.min(...measurements);
                const avg = measurements.reduce((a, b) => a + b, 0) / measurements.length;

                allData[currentSample].min = min;
                allData[currentSample].avg = avg;

                document.getElementById('minValue').textContent = min.toFixed(1);
                document.getElementById('avgValue').textContent = avg.toFixed(1);
            } else {
                allData[currentSample].min = null;
                allData[currentSample].avg = null;

                document.getElementById('minValue').textContent = '-';
                document.getElementById('avgValue').textContent = '-';
            }

            updateSummaryTable();
        }

        // Update progress indicator
        function updateProgress() {
            const allData = getAllData();
            const filledCount = allData[currentSample].measurements.filter(m => m !== null).length;
            document.getElementById('progressIndicator').textContent = `${filledCount} / ${MEASUREMENTS_PER_SAMPLE}`;
        }

        // Select a sample
        function selectSample(index) {
            currentSample = index;
            updateCurrentTitle();

            generateSampleSelector();
            generateDataGrid();
            updateResults();
            updateProgress();
        }

        // Clear current sample data
        function clearCurrentSample() {
            if (confirm('ÌòÑÏû¨ ÏãúÎ£åÏùò Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                const allData = getAllData();
                allData[currentSample].measurements = new Array(MEASUREMENTS_PER_SAMPLE).fill(null);
                allData[currentSample].min = null;
                allData[currentSample].avg = null;

                generateDataGrid();
                updateResults();
                updateProgress();
                generateSampleSelector();
            }
        }

        // Go to next sample
        function goToNextSample() {
            // ÌòÑÏû¨ ÏãúÎ£åÏùò ÏûÖÎ†•Îêú Îç∞Ïù¥ÌÑ∞ Í∞úÏàò ÌôïÏù∏
            const allData = getAllData();
            const filledCount = allData[currentSample].measurements.filter(m => m !== null).length;

            // 20Í∞ú ÎØ∏ÎßåÏù∏ Í≤ΩÏö∞ Í≤ΩÍ≥† ÌåùÏóÖ
            if (filledCount < MEASUREMENTS_PER_SAMPLE) {
                const remaining = MEASUREMENTS_PER_SAMPLE - filledCount;
                if (!confirm(`‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞Í∞Ä ${filledCount}/${MEASUREMENTS_PER_SAMPLE}Í∞úÎßå ÏûÖÎ†•ÎêòÏóàÏäµÎãàÎã§.\n\n${remaining}Í∞úÏùò Îç∞Ïù¥ÌÑ∞Í∞Ä Îçî ÌïÑÏöîÌï©ÎãàÎã§.\n\nÍ∑∏ÎûòÎèÑ Îã§Ïùå ÏãúÎ£åÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                    return; // Ï∑®ÏÜå Ïãú ÌòÑÏû¨ ÏãúÎ£åÏóê Ïú†ÏßÄ
                }
            }

            if (currentSample < TOTAL_SAMPLES - 1) {
                selectSample(currentSample + 1);
            } else {
                alert('ÎßàÏßÄÎßâ ÏãúÎ£åÏûÖÎãàÎã§.');
            }
        }

        // Update summary table
        function updateSummaryTable() {
            const tbody = document.getElementById('summaryTableBody');
            tbody.innerHTML = '';
            const allData = getAllData();

            for (let i = 0; i < TOTAL_SAMPLES; i++) {
                const row = document.createElement('tr');

                const sampleCell = document.createElement('td');
                sampleCell.textContent = `#${i + 1}`;

                const minCell = document.createElement('td');
                minCell.textContent = allData[i].min !== null ? allData[i].min.toFixed(1) : '-';
                minCell.style.color = allData[i].min !== null ? '#ff5722' : '#888';

                const avgCell = document.createElement('td');
                avgCell.textContent = allData[i].avg !== null ? allData[i].avg.toFixed(1) : '-';
                avgCell.style.color = allData[i].avg !== null ? '#4caf50' : '#888';

                row.appendChild(sampleCell);
                row.appendChild(minCell);
                row.appendChild(avgCell);
                tbody.appendChild(row);
            }
        }

        // Export data
        function exportData() {
            const allData = getAllData();
            let csvContent = `${materials[currentMaterial].name}\n`;
            csvContent += 'ÏãúÎ£åÎ≤àÌò∏,';

            // Header row for measurements
            for (let i = 1; i <= MEASUREMENTS_PER_SAMPLE; i++) {
                csvContent += `Ï∏°Ï†ï${i},`;
            }
            csvContent += 'ÏµúÏÜüÍ∞í,ÌèâÍ∑†Í∞í\n';

            // Data rows
            for (let i = 0; i < TOTAL_SAMPLES; i++) {
                csvContent += `${i + 1},`;

                for (let j = 0; j < MEASUREMENTS_PER_SAMPLE; j++) {
                    csvContent += (allData[i].measurements[j] !== null ? allData[i].measurements[j] : '') + ',';
                }

                csvContent += (allData[i].min !== null ? allData[i].min.toFixed(1) : '') + ',';
                csvContent += (allData[i].avg !== null ? allData[i].avg.toFixed(1) : '') + '\n';
            }

            // Create and download file
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `ÏïÑÏó∞ÎèÑÍ∏àÎëêÍªòÏ∏°Ï†ï_${materials[currentMaterial].name}_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Camera functionality
        let videoStream = null;

        async function startCamera() {
            // HTTPS Check
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                alert('Ïπ¥Î©îÎùº Í∏∞Îä•ÏùÄ Î≥¥Ïïà Î¨∏Ï†úÎ°ú HTTPS ÎòêÎäî localhost ÌôòÍ≤ΩÏóêÏÑúÎßå ÏûëÎèôÌï©ÎãàÎã§.');
                return;
            }

            try {
                const modal = document.getElementById('cameraModal');
                const video = document.getElementById('cameraVideo');
                
                // Try getting rear camera
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { ideal: 'environment' }
                    }
                });
                
                video.srcObject = videoStream;
                modal.style.display = 'flex';
                
                // Ensure video plays (sometimes needed for mobile)
                video.play();
                
                // Check if we have an active input
                highlightNextEmpty();
            } catch (err) {
                console.error(err);
                alert('Ïπ¥Î©îÎùºÎ•º Ïã§ÌñâÌï† Ïàò ÏóÜÏäµÎãàÎã§.\nÍ∂åÌïúÏùÑ ÌóàÏö©ÌñàÎäîÏßÄ, Îã§Î•∏ Ïï±ÏóêÏÑú Ïπ¥Î©îÎùºÎ•º ÏÇ¨Ïö© Ï§ëÏù∏ÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.\nÏò§Î•ò: ' + err.message);
            }
        }

        function stopCamera() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            const loading = document.getElementById('loadingOverlay');

            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            video.srcObject = null;
            modal.style.display = 'none';
            loading.style.display = 'none';
        }

        async function captureAndScan() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('captureCanvas');
            const loading = document.getElementById('loadingOverlay');

            if (!video.videoWidth) return;

            // Show loading overlay
            loading.style.display = 'flex';

            // Wait a bit to render overlay
            await new Promise(r => setTimeout(r, 100));

            // Set canvas size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Tesseract requires basic image processing for better results
            // We'll trust its auto-thresholding for now, but could enhance contrast here if needed
            
            try {
                // Perform OCR
                // Using 'eng' as it's best for numbers. 'kor' often confuses numbers with similar hangul chars.
                const worker = await Tesseract.createWorker('eng');
                
                // Constrain recognition to numbers effectively
                // Tesseract.js parameters can optimize this
                await worker.setParameters({
                    tessedit_char_whitelist: '0123456789.', // Only numbers and dot
                });
                
                const ret = await worker.recognize(canvas);
                const text = ret.data.text;
                
                console.log('Recognized Raw:', text);
                
                await worker.terminate();

                // Process result
                const match = text.match(/[\d]+(\.[\d]+)?/);
                
                if (match) {
                    const number = match[0];
                    const numValue = parseFloat(number);
                    
                    if (isNaN(numValue)) throw new Error('Not a number');
                    
                    // Find target input
                    let targetInput = document.querySelector('.data-input.current');
                    
                    // If no current highlight, find first empty
                    if (!targetInput) {
                        const allData = getAllData();
                        for(let i=0; i<MEASUREMENTS_PER_SAMPLE; i++) {
                            if(allData[currentSample].measurements[i] === null) {
                                targetInput = document.getElementById(`input-${i}`);
                                break;
                            }
                        }
                    }

                    if (targetInput) {
                        // Apply value
                        targetInput.value = number;
                        const index = parseInt(targetInput.id.split('-')[1]);
                        handleInput(index, number);
                        
                        // Success Feedback
                        stopCamera();
                        
                        // Move to next
                        const nextIndex = index + 1;
                        if(nextIndex < MEASUREMENTS_PER_SAMPLE) {
                           highlightCurrentInput(nextIndex);
                           const nextInput = document.getElementById(`input-${nextIndex}`);
                           if(nextInput) nextInput.focus();
                        }
                        
                    } else {
                        alert('ÏûÖÎ†•Ìï† Îπà Ïπ∏Ïù¥ ÏóÜÏäµÎãàÎã§.');
                        stopCamera();
                    }
                    
                } else {
                    alert('Ïà´ÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                    loading.style.display = 'none'; // Only hide loading if failed, so user can retry
                }
                
            } catch (e) {
                console.error(e);
                alert('Ïù∏Ïãù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + e.message);
                loading.style.display = 'none';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeData();
            generateMaterialSelector();
            generateSampleSelector();
            generateDataGrid();
            updateSummaryTable();
        });
    </script>
    <div id="cameraModal" class="camera-modal">
        <button class="close-camera-btn" onclick="stopCamera()">‚úï</button>
        <video id="cameraVideo" class="camera-view" playsinline autoplay muted></video>
        <div class="camera-overlay">
            <div class="camera-guide-text">Ïà´ÏûêÎ•º Ïù¥ Î∞ïÏä§ ÏïàÏóê ÎßûÏ∂∞Ï£ºÏÑ∏Ïöî</div>
        </div>
        <div class="camera-controls">
            <button class="shutter-btn" onclick="captureAndScan()"></button>
        </div>
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner"></div>
            <div style="color:white; font-size: 1.2rem; font-weight: bold;">Ïà´Ïûê Ïù∏Ïãù Ï§ë...</div>
        </div>
        <canvas id="captureCanvas" style="display:none;"></canvas>
    </div>
</body>

</html>
